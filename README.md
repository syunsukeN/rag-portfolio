# 社内資料検索・質問応答AI（RAGベース）

業務特化型のRAG（Retrieval-Augmented Generation）システムのポートフォリオです。

**現在のバージョン: v2.1.0**（チャンク分割 + クエリ拡張対応）

## 🎯 このプロジェクトで示したいこと

| 観点 | 実装内容 |
|------|----------|
| AIを直接信用しない設計 | プロンプトで「資料にないことは答えない」よう制御 |
| 業務データに限定した回答 | ベクトルDBに登録した文書のみを参照 |
| 参照元の明示 | 回答と共に根拠となる資料名・セクション名を返却 |
| 検索精度の向上 | チャンク分割・クエリ拡張・見出し込み埋め込み |
| 信頼度の可視化 | 検索結果の信頼度レベル（high/medium/low）を表示 |
| 実運用を想定したAPI設計 | FastAPIによるRESTful API |

## 🏗️ アーキテクチャ

```text
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Frontend   │────▶│   FastAPI   │────▶│   Gemini    │
│  (HTML/JS)  │◀────│   Backend   │◀────│   API       │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  ChromaDB   │
                    │ (VectorDB)  │
                    └─────────────┘
```

## 🔧 技術スタック

| 項目 | 技術 |
|------|------|
| バックエンド | Python / FastAPI |
| ベクトルDB | ChromaDB |
| Embedding | Gemini text-embedding-004 |
| LLM | Gemini 2.5 Flash |
| フロントエンド | HTML / CSS / JavaScript |

## 📁 ディレクトリ構成

```text
rag-portfolio/
├── main.py            # FastAPIサーバー（v2.1.0）
├── setup_db.py        # ドキュメントのベクトル化
├── chunker.py         # チャンク分割モジュール（H2見出し単位）
├── query_expander.py  # クエリ拡張モジュール（LLMキーワード追加）
├── requirements.txt   # 依存ライブラリ
├── .env.example       # 環境変数テンプレート
├── data/
│   └── docs/          # 社内資料（サンプル）
└── frontend/
    └── index.html     # 質問UI
```

## 🚀 セットアップ

### 1. リポジトリをクローン

```bash
git clone https://github.com/yourusername/rag-portfolio.git
cd rag-portfolio
```

### 2. 仮想環境を作成・有効化

```bash
python3 -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows
```

### 3. ライブラリをインストール

```bash
pip3 install -r requirements.txt
```

### 4. 環境変数を設定

```bash
cp .env.example .env
# .env を編集してAPIキーを設定
```

### 5. ドキュメントをベクトル化

```bash
python3 setup_db.py
```

### 6. サーバーを起動

```bash
python3 -m uvicorn main:app --reload
```

### 7. フロントエンドにアクセス

`frontend/index.html` をブラウザで開く

---

## 🐳 Docker起動（推奨）

### なぜDockerを使うのか

| 目的 | 説明 |
|------|------|
| 再現性の確保 | 誰の環境でも同じ動作を保証 |
| 環境構築の簡素化 | Python/pipのバージョン差異を吸収 |
| 本番想定の構成 | 実運用を見据えたコンテナ化 |

### クイックスタート

```bash
# 1. リポジトリをクローン
git clone https://github.com/yourusername/rag-portfolio.git
cd rag-portfolio

# 2. 環境変数を設定
cp .env.example .env
# .env を編集してAPIキーを設定

# 3. コンテナを起動
docker compose up -d

# 4. データベースを初期化
docker compose exec -e SKIP_CONFIRMATION=true api python setup_db.py

# 5. 動作確認
curl http://localhost:8000/health
```

### コマンドリファレンス

| コマンド | 説明 |
|---------|------|
| `docker compose up -d` | バックグラウンドで起動 |
| `docker compose down` | 停止 |
| `docker compose logs -f api` | ログを確認 |
| `docker compose exec api python setup_db.py` | DB再構築（対話モード） |
| `docker compose exec -e SKIP_CONFIRMATION=true api python setup_db.py` | DB再構築（自動モード） |

### 注意事項

- `data/docs/` にMarkdownファイルがない状態でDB初期化すると失敗します
- フロントエンドはDockerに含まれますが、ブラウザで `frontend/index.html` を直接開いて使用します
- APIは `http://localhost:8000` でアクセス可能です

---

## 📡 API エンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/` | ルート（動作確認） |
| GET | `/health` | ヘルスチェック |
| POST | `/search` | ドキュメント検索 |
| POST | `/ask` | 質問応答（RAG） |

### `/ask` リクエスト例

```json
{
  "text": "有給休暇は何日もらえますか？"
}
```

### レスポンス例（v2.1.0）

```json
{
  "question": "有給休暇は何日もらえますか？",
  "expanded_query": "有給休暇は何日もらえますか？ 有給 勤怠 休み",
  "added_keywords": ["有給", "勤怠", "休み"],
  "answer": "入社6ヶ月後に10日付与されます。",
  "sources": ["attendance.md"],
  "sections": [
    {
      "filename": "attendance.md",
      "section_title": "有給休暇",
      "similarity_score": 0.85
    }
  ],
  "confidence": "high",
  "version": "2.1.0"
}
```

| フィールド | 説明 |
|------------|------|
| expanded_query | クエリ拡張後の検索クエリ |
| added_keywords | LLMが追加したキーワード |
| sections | 参照したセクションの詳細情報 |
| confidence | 検索結果の信頼度（high/medium/low） |
| version | APIバージョン |

## 🛡️ 設計上の工夫

### 1. ハルシネーション対策

```python
system_prompt = """
1. 提供された社内資料のみを参照して回答してください
2. 資料に書かれていない情報は「その情報は社内資料に記載がありません」と回答してください
"""
```

### 2. 回答の根拠を明示

検索にヒットした資料名・セクション名を`sources`と`sections`で返却し、回答の信頼性を担保。

### 3. チャンク分割（v2.0.0で追加）

ドキュメント全体ではなく、H2見出し単位でセクションに分割して検索。

```
Before: attendance.md 全体（4セクション分）→ AIに渡す
After:  有給休暇セクションのみ → AIに渡す（情報量60%削減）
```

**メリット:**
- 必要な情報だけをAIに渡せる
- レイテンシとコストの削減
- どのセクションを参照したか追跡可能

### 4. 信頼度スコア（v2.0.0で追加）

検索結果の類似度に基づいて信頼度レベルを計算。

| 信頼度 | 類似度 | 意味 |
|--------|--------|------|
| high | 0.8以上 | ほぼ完全一致、自信を持って回答 |
| medium | 0.6以上 | 関連性あり、注意付きで回答 |
| low | 0.6未満 | 関連性薄い、回答を控える |

### 5. クエリ拡張（v2.1.0で追加）

LLMでドメイン固有のキーワードを自動追加し、検索精度を向上。

```
Before: 「有給の申請方法は？」
After:  「有給の申請方法は？ 有給休暇 勤怠 休み 勤怠くん」
```

**フォールバック設計:** API障害時も元のクエリで検索を継続。

### 6. 見出し込み埋め込み（v2.1.0で追加）

H2見出しをチャンクの先頭に含めることで、ドメイン識別を強化。

```
Before: 「- 有給休暇は入社6ヶ月後に10日付与されます」
After:  「## 有給休暇\n- 有給休暇は入社6ヶ月後に10日付与されます」
```

## ⚠️ 現在の限界点

このプロジェクトは学習・ポートフォリオ目的で作成しており、以下の制限があります。

### 技術的な限界

| 項目 | 現状 | 本番で必要な対応 |
|------|------|------------------|
| 認証/認可 | なし | OAuth2/JWTの実装 |
| レート制限 | なし | APIゲートウェイ導入 |
| CORS | 全オリジン許可 | 特定ドメインに制限 |
| ログ | 標準出力のみ | 構造化ログ + 外部収集 |
| 監視 | ヘルスチェックのみ | Prometheus/Grafana |

### RAG固有の課題

| 課題 | 現状 | 改善案 |
|------|------|--------|
| 抽象的なクエリ | 正しく検索できないことがある | 聞き返しUI / クエリ分類 |
| 評価指標 | 未計測 | Recall@k / 評価用質問セット |
| 検索精度 | ベクトル検索のみ | ハイブリッド検索（BM25 + ベクトル） |
| チャンク戦略 | H2見出し固定 | セマンティックチャンキング |

---

## 🚧 次フェーズの改善方針

### 完了済み
- [x] ドキュメントのチャンク分割で検索精度向上（v2.0.0）
- [x] 検索スコアの閾値設定・信頼度表示（v2.0.0）
- [x] クエリ拡張機能（v2.1.0）
- [x] 見出し込み埋め込み（v2.1.0）
- [x] Docker化（v2.2.0）

### 短期目標
- [ ] 評価用質問セット（20問）の作成
- [ ] Recall@k の計測スクリプト実装
- [ ] 失敗ケースの分類と記録

### 中期目標
- [ ] ハイブリッド検索の導入（BM25 + ベクトル）
- [ ] リランキング機能（Cohere Rerank等）
- [ ] フィードバックボタンの実装
- [ ] 抽象的なクエリへの対応（聞き返しUI）

### 長期目標
- [ ] ユーザー認証（Auth0/Firebase Auth）
- [ ] 管理画面（ドキュメント登録UI）
- [ ] 本番環境へのデプロイ（Cloud Run/ECS）
- [ ] 回答のストリーミング対応

---

## 💼 ポートフォリオとしての見どころ

採用担当者の方へ：このプロジェクトで示したい能力です。

### 1. 実務を意識した設計

- **ハルシネーション対策**: プロンプトエンジニアリングで「資料にないことは答えない」よう制御
- **回答の根拠明示**: 参照したドキュメント・セクションを返却し透明性を確保
- **信頼度スコア**: 検索結果の類似度に基づく不確実性の可視化
- **フォールバック機構**: API障害時も元のクエリで検索を継続

### 2. 段階的な改善

| バージョン | 改善内容 |
|------------|----------|
| v1.0.0 | 基本的なRAG機能 |
| v2.0.0 | チャンク分割 + 信頼度スコア |
| v2.1.0 | クエリ拡張 + 見出し込み埋め込み |
| v2.2.0 | Docker化 + 運用ドキュメント整備 |

### 3. 運用を見据えた構成

- Docker化による環境の再現性
- ヘルスチェックエンドポイント
- 構造化されたログ出力
- 環境変数による設定の外部化
- 非対話モード対応（CI/CD連携可能）

### 4. 技術的な自己認識

限界点を正直に記載し、改善計画を立てている点が、実務で重要な「自己認識能力」を示しています。
完璧なシステムではなく、「何ができて何ができないか」を明確にし、継続的に改善していく姿勢を重視しています。

---

## 📄 ライセンス

MIT License
